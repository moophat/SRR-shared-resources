name: Populate Downstream

on:
  push:
    branches:
      - main

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout shared repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Required for subtree split to access full history

      - name: Install yq (Go version)
        run: |
          mkdir -p $HOME/bin
          curl -L https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -o $HOME/bin/yq
          chmod +x $HOME/bin/yq
        shell: bash
      
      - name: Add yq to PATH
        run: echo "$HOME/bin" >> $GITHUB_PATH

      - name: Run downstream sync
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          set -e

          CONFIG="$GITHUB_WORKSPACE/.github/consumer-config.yml"
          TMPDIR=$(mktemp -d)

          # Get shared repo HEAD for commit message traceability
          SHARED_COMMIT=$(git rev-parse --short HEAD)

          # Pre-split all folders needed by any consumer
          for folder in $(yq e '.. | select(has("folders")) | .folders | keys | .[]' "$CONFIG" | sort -u); do
            echo "üå≤ Splitting shared folder: $folder"
            git subtree split --prefix="$folder" -b "split-$folder"
          done

          for consumer in $(yq e 'keys | .[]' "$CONFIG"); do
            REPO=$(yq e ".\"$consumer\".repo" "$CONFIG")
            echo "üîÑ Syncing consumer: $consumer ($REPO)"

            # Clone consumer repo once
            cd "$TMPDIR"
            git clone "https://${GH_PAT}@${REPO#https://}" "$consumer"
            cd "$consumer"

            # Set git identity for commits
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            # Create or checkout sync-auto branch
            git checkout -b sync-auto || git checkout sync-auto

            # Link back to shared repo to fetch split branches
            git remote add shared "$GITHUB_WORKSPACE"
            git fetch shared

            # Loop through folders
            for folder in $(yq e ".\"$consumer\".folders | keys | .[]" "$CONFIG"); do
              TARGET_PATH=$(yq e ".\"$consumer\".folders.\"$folder\"" "$CONFIG")
              echo "üì¶ Injecting $folder ‚Üí $TARGET_PATH"

              cd "$TMPDIR/$consumer"

              # Create target directory if it doesn't exist
              mkdir -p "$TARGET_PATH"

              # Remove all previous files from target path before injection, to ensure deletions sync correctly
              rm -rf "$TARGET_PATH"/*

              # Inject folder content using work-tree (note: only syncs latest snapshot, not full history)
              git --work-tree="$TARGET_PATH" checkout "shared/split-$folder" -- .

            done

            # Commit all changes
            git add -A .
            git commit -m "[auto-sync][$consumer] update shared folders

Source: moophat/SRR-shared-resources@$SHARED_COMMIT" || echo "‚ö†Ô∏è Nothing to commit"

            # Force push to sync-auto branch
            git push -f origin sync-auto

            cd "$TMPDIR"
          done
