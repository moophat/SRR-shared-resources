name: Populate Downstream

on:
  push:
    branches:
      - main

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout shared repo
        uses: actions/checkout@v3

      - name: Install yq (Go version)
        run: |
          mkdir -p $HOME/bin
          curl -L https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -o $HOME/bin/yq
          chmod +x $HOME/bin/yq
        shell: bash
      
      - name: Add yq to PATH
        run: echo "$HOME/bin" >> $GITHUB_PATH

      - name: Run downstream sync
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          set -e

          CONFIG="$GITHUB_WORKSPACE/.github/consumer-config.yml"
          TMPDIR=$(mktemp -d)

          for consumer in $(yq e 'keys | .[]' "$CONFIG"); do
            REPO=$(yq e ".\"$consumer\".repo" "$CONFIG")
            echo "üîÑ Syncing consumer: $consumer ($REPO)"

            # Clone consumer repo once
            cd "$TMPDIR"
            git clone "https://${GH_PAT}@${REPO#https://}" "$consumer"
            cd "$consumer"
            # Set git identify for this folder
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            
            # go into the sync-auto branch of the consumer repo do do our fucking magic
            git checkout -b sync-auto || git checkout sync-auto

            # Link back to shared repo to fetch split branches
            git remote add shared "$GITHUB_WORKSPACE"
            git fetch shared

            # Loop through folders
            for folder in $(yq e ".\"$consumer\".folders | keys | .[]" "$CONFIG"); do
              TARGET_PATH=$(yq e ".\"$consumer\".folders.\"$folder\"" "$CONFIG")
              echo "üì¶ Injecting $folder ‚Üí $TARGET_PATH"

              cd "$TMPDIR/$consumer"
              

              
              mkdir -p "$TARGET_PATH"
              # set the DESTINATION folder
              git --work-tree="$TARGET_PATH" checkout "shared/split-$folder" -- .
            done

            git add .
            git commit -m "[auto-sync][$consumer] update shared folders" || echo "‚ö†Ô∏è Nothing to commit"
            git push -f origin HEAD:sync-auto

            cd "$TMPDIR"
          done
