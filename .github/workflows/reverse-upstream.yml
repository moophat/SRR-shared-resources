name: Reverse Upstream Sync â€“ Pull from Consumer

on:
  repository_dispatch:
    types: [push-upstream]

jobs:
  reverse-upstream:
    runs-on: ubuntu-latest

    steps:
      # clone the shared-resources repo
      - name: Checkout self (shared repo)
        uses: actions/checkout@v4

      # install yq (Go version)
      - name: Install yq
        run: |
          mkdir -p $HOME/bin
          curl -L https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -o $HOME/bin/yq
          chmod +x $HOME/bin/yq

      # grab consumer name from payload
      - name: Extract consumer name
        id: extract
        run: echo "consumer=${{ github.event.client_payload.consumer }}" >> $GITHUB_OUTPUT

      # extract repo URL from consumer-config.yml
      - name: Load consumer repo info
        id: config
        run: |
          CONFIG=".github/consumer-config.yml"
          CONSUMER="${{ steps.extract.outputs.consumer }}"
          REPO=$(yq e ".\"$CONSUMER\".repo" "$CONFIG")
          echo "repo=$REPO" >> $GITHUB_OUTPUT

      # clone the actual consumer repo and prepare for split
      - name: Clone consumer and checkout main
        run: |
          git clone "${{ steps.config.outputs.repo }}" consumer
          cd consumer
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout main

      # main split and push loop
      - name: Subtree split and push
        run: |
          set -e
          cd consumer

          CONFIG="$GITHUB_WORKSPACE/.github/consumer-config.yml"
          CONSUMER="${{ steps.extract.outputs.consumer }}"

          yq e ".\"$CONSUMER\".folders" "$CONFIG" | \
          yq e 'to_entries | .[] | .value + ":" + .key' - | while IFS=":" read -r local_path shared_folder; do
            echo "Splitting $local_path into subtree branch tmp-upstream-split-$shared_folder"
            git subtree split --prefix="$local_path" -b "tmp-upstream-split-$shared_folder"

            TARGET_BRANCH="from-${CONSUMER}-${shared_folder}"
            echo "Pushing split to shared-resources:$TARGET_BRANCH"
            git push origin "tmp-upstream-split-$shared_folder:$TARGET_BRANCH" --force
          done
