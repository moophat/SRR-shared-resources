name: Reverse Upstream Sync

on:
  repository_dispatch:
    types: [push-upstream]

jobs:
  sync-from-consumer:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout shared repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Required for subtree operations

      - name: Install yq (Go version)
        run: |
          mkdir -p $HOME/bin
          curl -L https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -o $HOME/bin/yq
          chmod +x $HOME/bin/yq

      - name: Add yq to PATH
        run: echo "$HOME/bin" >> $GITHUB_PATH

      - name: Extract payload data
        id: payload
        run: |
          echo "consumer=${{ github.event.client_payload.consumer }}" >> $GITHUB_OUTPUT
          echo "folder=${{ github.event.client_payload.folder }}" >> $GITHUB_OUTPUT
          echo "commit_sha=${{ github.event.client_payload.commit_sha }}" >> $GITHUB_OUTPUT
          echo "commit_message=${{ github.event.client_payload.commit_message }}" >> $GITHUB_OUTPUT

      - name: Validate payload
        run: |
          if [ -z "${{ steps.payload.outputs.consumer }}" ]; then
            echo "‚ùå Error: consumer name is required in payload"
            exit 1
          fi
          if [ -z "${{ steps.payload.outputs.folder }}" ]; then
            echo "‚ùå Error: folder name is required in payload"
            exit 1
          fi
          if [ -z "${{ steps.payload.outputs.commit_sha }}" ]; then
            echo "‚ùå Error: commit_sha is required in payload"
            exit 1
          fi

      - name: Pull from consumer and inject into shared
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          set -e

          CONSUMER="${{ steps.payload.outputs.consumer }}"
          FOLDER="${{ steps.payload.outputs.folder }}"
          COMMIT_SHA="${{ steps.payload.outputs.commit_sha }}"
          COMMIT_MSG="${{ steps.payload.outputs.commit_message }}"

          CONFIG="$GITHUB_WORKSPACE/.github/consumer-config.yml"

          echo "üîÅ Processing upstream sync from consumer: $CONSUMER"
          echo "   Folder: $FOLDER"
          echo "   Commit: $COMMIT_SHA"

          # Get consumer repo URL and local path for the folder
          CONSUMER_REPO=$(yq e ".\"$CONSUMER\".repo" "$CONFIG")
          LOCAL_PATH=$(yq e ".\"$CONSUMER\".folders.\"$FOLDER\"" "$CONFIG")

          if [ "$CONSUMER_REPO" = "null" ]; then
            echo "‚ùå Error: Consumer '$CONSUMER' not found in config"
            exit 1
          fi

          if [ "$LOCAL_PATH" = "null" ]; then
            echo "‚ùå Error: Folder '$FOLDER' not configured for consumer '$CONSUMER'"
            exit 1
          fi

          echo "   Consumer repo: $CONSUMER_REPO"
          echo "   Consumer path: $LOCAL_PATH"

          # Clone consumer repo
          TMPDIR=$(mktemp -d)
          cd "$TMPDIR"
          git clone "https://${GH_PAT}@${CONSUMER_REPO#https://}" consumer
          cd consumer

          # Checkout specific commit SHA
          git checkout "$COMMIT_SHA"

          # Set git identity
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Split the specified folder from consumer
          SPLIT_BRANCH="split-$FOLDER"
          echo "üå≤ Splitting consumer folder: $LOCAL_PATH"
          git subtree split --prefix="$LOCAL_PATH" -b "$SPLIT_BRANCH"

          # Inject into shared repo
          cd "$GITHUB_WORKSPACE"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create branch name for upstream PR
          BRANCH_NAME="from-$CONSUMER-$FOLDER"
          echo "üìù Creating branch: $BRANCH_NAME"

          # Create branch from latest main
          git fetch origin
          git checkout -b "$BRANCH_NAME" origin/main

          # Create shared folder directory if needed
          mkdir -p "$FOLDER"

          # Remove all previous files from shared folder before injection, to ensure deletions sync correctly
          rm -rf "$FOLDER"/*

          # Inject content from consumer split branch
          git --git-dir="$TMPDIR/consumer/.git" \
              --work-tree="$GITHUB_WORKSPACE/$FOLDER" \
              checkout "$SPLIT_BRANCH" -- .

          # Commit changes
          git add -A "$FOLDER"

          if git diff --cached --quiet; then
            echo "‚ö†Ô∏è No changes to commit"
          else
            # Create commit message with traceability
            if [ -n "$COMMIT_MSG" ]; then
              git commit -m "[auto-sync][$CONSUMER] update $FOLDER from consumer" -m "Original commit message: $COMMIT_MSG" -m "Consumer: $CONSUMER_REPO@$COMMIT_SHA"
            else
              git commit -m "[auto-sync][$CONSUMER] update $FOLDER from consumer" -m "Consumer: $CONSUMER_REPO@$COMMIT_SHA"
            fi

            # Push branch (normal push, not force)
            echo "‚¨ÜÔ∏è Pushing branch to origin"
            git push origin "$BRANCH_NAME"

            echo "‚úÖ Successfully created branch: $BRANCH_NAME"
            echo "   Next: Create PR from $BRANCH_NAME ‚Üí main"
          fi

          # Cleanup
          cd "$GITHUB_WORKSPACE"
          rm -rf "$TMPDIR"
