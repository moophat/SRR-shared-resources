name: Reverse Upstream Sync – Pull from Consumer

on:
  repository_dispatch:
    types: [push-upstream]

jobs:
  reverse-upstream:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout self
        uses: actions/checkout@v4

      - name: Install yq
        run: |
          mkdir -p $HOME/bin
          curl -L https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -o $HOME/bin/yq
          chmod +x $HOME/bin/yq
        shell: bash

      - name: Extract consumer name
        id: extract
        run: echo "consumer=${{ github.event.client_payload.consumer }}" >> $GITHUB_OUTPUT

      - name: Parse consumer repo and folders
        id: config
        run: |
          CONFIG=".github/consumer-config.yml"
          CONSUMER="${{ steps.extract.outputs.consumer }}"
          echo "REPO=$(yq e ".\"$CONSUMER\".repo" "$CONFIG")" >> $GITHUB_ENV
        shell: bash

      - name: Clone consumer repo
        run: |
          git clone "https://${{ secrets.GH_PAT }}@${REPO#https://}" consumer
          cd consumer
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout main

      - name: Subtree split and push to shared-resources
        run: |
          set -e
          cd consumer

          CONFIG="$GITHUB_WORKSPACE/.github/consumer-config.yml"
          CONSUMER="${{ steps.extract.outputs.consumer }}"

          for entry in $(yq e ".\"$CONSUMER\".folders | to_entries | .[] | .value + \":\" + .key" "$CONFIG"); do
            LOCAL_PATH="${entry%%:*}"
            SHARED_FOLDER="${entry##*:}"
            BRANCH_NAME="tmp-upstream-split-$SHARED_FOLDER"
            TARGET_BRANCH="from-${CONSUMER}-${SHARED_FOLDER}"

            echo "Splitting $LOCAL_PATH → $SHARED_FOLDER"
            git subtree split --prefix="$LOCAL_PATH" -b "$BRANCH_NAME"

            cd "$GITHUB_WORKSPACE"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git remote set-url origin "https://${{ secrets.GH_PAT }}@github.com/moophat/SRR-shared-resources.git"
            git push -f origin "$BRANCH_NAME:$TARGET_BRANCH"
          done
